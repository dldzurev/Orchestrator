<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Bitcoin Price - Clean Indicators (final)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://unpkg.com">
<!-- Strategy UI styles -->
<link rel="stylesheet" href="strategy.css">

<style>
  .price-up { color: #16a34a; font-weight: 600; }
  .price-down { color: #dc2626; font-weight: 600; }

  html, body { height:100%; overflow:hidden; }
  body { background:#ffffff; margin:0; padding:12px; font-family:"Courier New", monospace; color:#111827; }

  .nav-card { background:#f8f9fa;border:1px solid #e5e7eb;border-radius:8px;padding:12px 16px;margin-bottom:12px;display:flex;gap:8px; }
  .nav-btn{flex:1;padding:8px 16px;border-radius:6px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
  .nav-btn.active{background:#111827;color:#fff;border-color:#111827}

  .screen { display:none; }
  .screen.active { display:block; }

  .layout{
    display:grid;
    grid-template-columns:320px 1fr;
    gap:12px;
    height: var(--viewerHeight, calc(100vh - 120px));
  }
  .left{display:flex;flex-direction:column;min-width:280px;height:100%;min-height:0;}
  .feed{flex:1;overflow:auto;border:1px solid #e5e7eb;border-radius:6px;padding:8px;background:#fff;min-height:0;}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#fff;padding:6px;border-bottom:2px solid #222}
  tbody td{padding:6px;border-bottom:1px solid #e5e7eb;white-space:nowrap}

  .right{
    display:flex;flex-direction:column;border:1px solid #e5e7eb;border-radius:8px;position:relative;overflow:hidden;background:#fff;
    height:100%;min-height:0;
  }
  .controls{height:44px;display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid #e5e7eb;background:#fff;flex:0 0 auto;}
  .btn{padding:6px 10px;border-radius:4px;border:1px solid #d1d5db;background:#f9fafb;cursor:pointer}
  #chartContainer{flex:1;display:flex;flex-direction:column;min-height:0}
  #chartDiv{flex:1;min-height:220px;position:relative;min-height:0}

  .indicators-wrapper{
    display:flex;flex-direction:column;border-top:1px solid #e5e7eb;background:#fafafa;flex:0 0 auto;
  }
  .indicator-row{display:flex;gap:12px;padding:8px;height:140px;align-items:stretch;flex:0 0 auto;}
  .indicator-card{flex:1;background:#2d2d2d;border-radius:6px;padding:8px;border:1px solid #404040;display:flex;flex-direction:column;min-width:0;}
  .indicator-header{color:#fff;font-size:12px;margin-bottom:6px;display:flex;justify-content:space-between}
  .indicator-canvas{flex:1;background:#2d2d2d;border-radius:4px;overflow:hidden;min-height:0;position:relative;}
  canvas.ind-canvas{width:100%;height:100%;display:block}

  .center-screen{
    border:1px dashed #d1d5db;border-radius:8px;height:calc(var(--viewerHeight,50vh));display:flex;align-items:center;justify-content:center;color:#6b7280;
  }

  /* Strategy Page Styles (kept as you provided) */
  .strategy-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .strategy-header { text-align:center; margin-bottom:40px; }
  .strategy-header h2 { font-size:2.5rem; font-weight:700; color:#111827; margin-bottom:8px; }
  .strategy-header p { font-size:1.1rem; color:#6b7280; }

  .strategy-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:24px; margin-bottom:40px; }

  .strategy-card { background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); overflow:hidden; transition:all .3s; }
  .strategy-card:hover { box-shadow:0 10px 25px -3px rgba(0,0,0,0.1); transform:translateY(-2px); }
  .card-header { padding:24px 24px 16px; border-bottom:1px solid #f3f4f6; }
  .card-header h3 { font-size:1.5rem; font-weight:600; margin:0; }
  .commodity-card .card-header h3 { color:#f59e0b; }
  .buy-card .card-header h3 { color:#10b981; }
  .sell-card .card-header h3 { color:#ef4444; }
  .card-content { padding:24px; }
  .dropdown-section { margin-bottom:16px; }
  .dropdown-item { margin-bottom:12px; }
  .strategy-dropdown { width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:8px; background:#fff; font-size:14px; color:#374151; transition:all .2s; }
  .strategy-dropdown:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }

  .add-btn { width:100%; padding:12px 16px; background:#f8fafc; border:2px dashed #d1d5db; border-radius:8px; color:#6b7280; font-size:14px; font-weight:500; cursor:pointer; }
  .add-btn:hover { background:#f1f5f9; border-color:#94a3b8; color:#475569; }

  .split-dropdown-container { display:flex; gap:8px; align-items:center; }
  .split-left, .split-right { flex:1; }
  .selected-option { padding:12px 16px; background:#f3f4f6; border:2px solid #d1d5db; border-radius:8px; text-align:center; font-weight:600; color:#374151; }
  .option-text { font-size:14px; text-transform:uppercase; letter-spacing:.5px; }
  .number-dropdown, .custom-number-input { width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:8px; background:#fff; font-size:14px; color:#374151; transition:all .2s; margin-top:8px; }
  .number-dropdown:focus, .custom-number-input:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }

  @media (max-width:900px){
    .layout{grid-template-columns:1fr;grid-auto-rows:auto;}
    .left{order:2} .right{order:1}
    .strategy-cards { grid-template-columns:1fr; }
  }

  /* spacing between dropdown rows */
  .str-rows, #strategyScreen .str-rows, #strategy-content .str-rows {
    display:flex; flex-direction:column; gap:10px;
  }
  .str-row { margin:0; }
</style>
</head>
<body>
  <div class="nav-card">
    <button class="nav-btn active" data-view="viewer">Viewer</button>
    <button class="nav-btn" data-view="strategy">Strategy</button>
    <button class="nav-btn" data-view="backtest">Backtest</button>
  </div>

  <div id="topbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div id="topbarLeft" style="display:flex;gap:12px;align-items:center">
      <select id="cryptoSelect" style="padding:6px;border-radius:4px;border:1px solid #d1d5db">
        <option>Bitcoin</option>
      </select>
      <div id="ticker">Bitcoin - Live Trading</div>
    </div>
    <div id="status" style="font-size:13px;color:#666">Connecting...</div>
  </div>

  <div id="viewerScreen" class="screen active">
    <div class="layout" id="viewerLayout">
      <div class="left">
        <div class="feed">
          <table>
            <thead>
              <tr><th class="mono">Time</th><th class="mono">Price</th><th class="mono">Move</th><th class="mono">%</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="right">
        <div class="controls">
          <button class="btn" data-range="1h">1H</button>
          <button class="btn" data-range="1d">1D</button>
          <button class="btn" data-range="1w">1W</button>
          <button class="btn" data-range="1m">1M</button>
        </div>

        <div id="chartContainer">
          <div id="chartDiv"></div>

          <div class="indicators-wrapper">
            <div class="indicator-row">
              <div class="indicator-card">
                <div class="indicator-header">
                  <span>Z-Score (returns)</span>
                  <span id="zscoreVal">--</span>
                </div>
                <div class="indicator-canvas">
                  <canvas id="zscoreCanvas" class="ind-canvas"></canvas>
                </div>
              </div>
            </div>
            <div class="indicator-row">
              <div class="indicator-card">
                <div class="indicator-header">
                  <span>Realized Volatility</span>
                  <span id="volVal">--</span>
                </div>
                <div class="indicator-canvas">
                  <canvas id="volCanvas" class="ind-canvas"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="strategyScreen" class="screen">
    <!-- Strategy UI -->
    <div class="strategy-container" id="strategyApp">
      <!-- Card: Commodity -->
      <div class="str-card" data-card="commodity">
        <div class="str-card__header">Commodity</div>
        <div class="str-card__body">
          <div class="str-rows">
            <div class="str-row" data-type="commodity">
              <select class="str-select">
                <option value="" selected disabled>Select…</option>
                <option value="a">a</option>
                <option value="b">b</option>
                <option value="c">c</option>
              </select>
            </div>
          </div>
          <button class="str-add" type="button">(+)&nbsp;Add</button>
          <div class="str-help">Add one or more items.</div>
        </div>
      </div>

      <!-- Card: Buy -->
      <div class="str-card" data-card="buy">
        <div class="str-card__header">Buy</div>
        <div class="str-card__body">
          <div class="str-rows">
            <div class="str-row" data-type="buy">
              <select class="str-select">
                <option value="" selected disabled>Select…</option>
                <option value="a">a</option>
                <option value="b">b</option>
                <option value="c">c</option>
              </select>
            </div>
          </div>
          <button class="str-add" type="button">(+)&nbsp;Add</button>
          <div class="str-help">Select an item, then enter a number.</div>
        </div>
      </div>

      <!-- Card: Sell -->
      <div class="str-card" data-card="sell">
        <div class="str-card__header">Sell</div>
        <div class="str-card__body">
          <div class="str-rows">
            <div class="str-row" data-type="sell">
              <select class="str-select">
                <option value="" selected disabled>Select…</option>
                <option value="a">a</option>
                <option value="b">b</option>
                <option value="c">c</option>
              </select>
            </div>
          </div>
          <button class="str-add" type="button">(+)&nbsp;Add</button>
          <div class="str-help">Select an item, then enter a number.</div>
        </div>
      </div>
    </div>

    <datalist id="qtySuggestions">
      <option value="1"></option>
      <option value="5"></option>
      <option value="10"></option>
    </datalist>

    <!-- Scoped strategy styles (kept) -->
    <style>
      #strategyScreen .strategy-container{
        padding:12px;
        display:grid;
        grid-template-columns:repeat(3, minmax(260px, 1fr));
        gap:12px;
      }
      #strategyScreen .str-card{
        background:#fff;
        border:1px solid #e5e7eb;
        border-radius:12px;
        box-shadow:0 8px 24px rgba(0,0,0,.08);
        display:flex; flex-direction:column; min-height:260px;
      }
      #strategyScreen .str-card__header{
        padding:12px 14px; border-bottom:1px solid #f2f3f5;
        font-weight:700; color:#111827; display:flex; align-items:center; justify-content:space-between;
      }
      #strategyScreen .str-card__body{ padding:12px; display:flex; flex-direction:column; gap:10px; }
      #strategyScreen .str-row{ display:flex; align-items:center; gap:8px; width:100%; }
      #strategyScreen .str-select{
        appearance:none; background:#f9fafb; border:1px solid #d1d5db; border-radius:10px;
        padding:10px 12px; color:#111827; font-family:"Courier New", monospace; font-size:14px; flex:1; cursor:pointer;
      }
      #strategyScreen .str-select:focus{ outline:2px solid #11182722; }
      #strategyScreen .str-add{
        align-self:flex-start; margin-top:2px; padding:8px 10px; border-radius:10px;
        background:#f9fafb; border:1px dashed #9ca3af; color:#111827; cursor:pointer;
        font-family:"Courier New", monospace; font-size:14px;
      }
      #strategyScreen .str-add:hover{ background:#eef2f7; }
      #strategyScreen .str-split{ display:flex; gap:8px; width:100%; }
      #strategyScreen .str-pill{
        flex:1; border-radius:10px; background:#111827; color:#fff; border:none; padding:10px 12px; text-align:left;
        font-family:"Courier New", monospace; font-size:14px; cursor:pointer;
      }
      #strategyScreen .str-number{
        flex:1; background:#fff; border:1px solid #d1d5db; border-radius:10px; padding:10px 12px;
        font-family:"Courier New", monospace; font-size:14px;
      }
      #strategyScreen .str-help{ margin-top:2px; font-size:12px; color:#6b7280; }
      @media (max-width:1000px){ #strategyScreen .strategy-container{ grid-template-columns:1fr; } }
    </style>

    <!-- NOTE: removed the inline strategy script that previously conflicted with the price addRow -->
  </div>

  <div id="backtestScreen" class="screen">
    <div class="center-screen">Backtest — Coming Soon</div>
  </div>

<script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>

<!-- keep one external strategy.js if you have it; defer load so it doesn't race -->
<script defer src="strategy.js"></script>

<script>
(() => {
  // view switching
  const navBtns = document.querySelectorAll('.nav-btn');
  const screens = {
    viewer: document.getElementById('viewerScreen'),
    strategy: document.getElementById('strategyScreen'),
    backtest: document.getElementById('backtestScreen'),
  };
  const topbarLeft = document.getElementById('topbarLeft');

  function setActiveView(name){
    Object.values(screens).forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if (screens[name]) screens[name].classList.add('active');
    const btn = document.querySelector(`.nav-btn[data-view="${name}"]`);
    if (btn) btn.classList.add('active');
    topbarLeft.style.display = (name === 'viewer') ? 'flex' : 'none';
    if (name === 'viewer') adjustViewerHeight();
  }
  navBtns.forEach(btn => btn.addEventListener('click', () => setActiveView(btn.dataset.view)));

  // viewer height
  const navCard = document.querySelector('.nav-card');
  const topbar  = document.getElementById('topbar');
  const viewerLayout = document.getElementById('viewerLayout');

  function adjustViewerHeight(){
    const pad = 24;
    const h = Math.max(0, window.innerHeight - navCard.offsetHeight - topbar.offsetHeight - pad);
    document.documentElement.style.setProperty('--viewerHeight', h + 'px');
    viewerLayout.style.height = 'var(--viewerHeight)';
  }
  window.addEventListener('resize', adjustViewerHeight);
  requestAnimationFrame(adjustViewerHeight);

  // crypto dropdown
  const cryptoSelect = document.getElementById('cryptoSelect');
  const tickerEl = document.getElementById('ticker');

  async function loadCryptos(){
    try{
      const res = await fetch('http://localhost:8000/api/cryptos');
      const data = await res.json();
      cryptoSelect.innerHTML = '';
      data.cryptos.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name === data.current) opt.selected = true;
        cryptoSelect.appendChild(opt);
      });
      updateTicker(data.current);
    }catch(e){ /* ignore */ }
  }
  function updateTicker(name){ tickerEl.textContent = `${name} - Live Trading`; }
  async function changeCrypto(name){
    try{
      const res = await fetch('http://localhost:8000/api/change-crypto', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ crypto: name })
      });
      const data = await res.json();
      if (data && data.success) {
        updateTicker(name);
        const activeBtn = document.querySelector('.btn.active');
        await loadHistory(activeBtn ? activeBtn.dataset.range : '1h');
      }
    }catch(e){ /* ignore */ }
  }
  cryptoSelect.addEventListener('change', (e)=> changeCrypto(e.target.value));

  // viewer/chart state
  let chart = null;
  let candleSeries = null;
  let overlaySeries = { ema12: null, ema26: null, bbUpper: null, bbLower: null };
  let candleBuckets = new Map();
  let resolutionSec = 60;
  let currentCandles = [];
  let currentIntervalSec = 60;

  function ensureChart() {
    if (chart) return;
    const div = document.getElementById('chartDiv');
    chart = LightweightCharts.createChart(div, {
      layout: { background: { type: 'solid', color: '#ffffff' }, textColor: '#111827', fontFamily: 'Courier New' },
      grid: { vertLines: { color: '#f3f4f6' }, horzLines: { color: '#f3f4f6' } },
      rightPriceScale: { borderColor: '#e5e7eb' },
      timeScale: { borderColor: '#e5e7eb', timeVisible: true, rightOffset: 10 },
      crosshair: { mode: LightweightCharts.CrosshairMode.Magnet }
    });
    window.addEventListener('resize', () => { chart.applyOptions({ width: div.clientWidth, height: div.clientHeight }); });
  }

  function setHistory(data, resSec) {
    ensureChart();
    resolutionSec = resSec;
    candleBuckets.clear();
    if (candleSeries) { chart.removeSeries(candleSeries); candleSeries = null; }

    let candles = [];
    if (data && Array.isArray(data.candles) && data.candles.length) {
      candles = data.candles.map(c => ({ time: c.t, open: c.o, high: c.h, low: c.l, close: c.c }));
    } else if (data && Array.isArray(data.points)) {
      candles = data.points.map(pt => { const p = Number(pt.p); return { time: Math.floor(new Date(pt.t).getTime()/1000), open: p, high: p, low: p, close: p }; });
    }
    candles.sort((a,b)=>a.time-b.time);
    currentCandles = candles;
    currentIntervalSec = (data && data.interval) ? Number(data.interval) : resSec;

    candleSeries = chart.addCandlestickSeries({
      upColor:'#16a34a', downColor:'#dc2626',
      borderUpColor:'#16a34a', borderDownColor:'#dc2626',
      wickUpColor:'#16a34a', wickDownColor:'#dc2626'
    });
    candleSeries.setData(candles);
    for (const c of candles) candleBuckets.set(c.time - (c.time % resolutionSec), c);

    for (const k in overlaySeries) { if (overlaySeries[k]) overlaySeries[k].setData([]); }

    computeAndRenderIndicatorsFromCandles();
  }

  // indicator math
  function ema(values, span) {
    const k = 2 / (span + 1);
    const out = []; let prev = null;
    for (let i=0;i<values.length;i++) { const v=values[i]; prev = (prev===null? v : prev + k*(v-prev)); out.push(prev); }
    return out;
  }
  function rollingMean(values, w) {
    const out = new Array(values.length).fill(null); let sum=0;
    for (let i=0;i<values.length;i++){ sum += values[i]; if(i>=w) sum -= values[i-w]; if(i>=w-1) out[i]=sum/w; }
    return out;
  }
  function rollingStd(values, w) {
    const out = new Array(values.length).fill(null);
    for (let i=0;i<values.length;i++){
      const start = Math.max(0, i - w + 1);
      const windowVals = values.slice(start, i+1);
      const n = windowVals.length;
      if (n <= 1) { out[i] = 0; continue; }
      let sum = 0;
      for (let v of windowVals) sum += v;
      const mean = sum / n;
      let ss = 0;
      for (let v of windowVals) { const d = v - mean; ss += d*d; }
      const variance = ss / (n - 1);
      out[i] = Math.sqrt(Math.max(0, variance));
    }
    return out;
  }

  function computeAndRenderIndicatorsFromCandles() {
    if (!currentCandles.length || !chart) return;
    const closes = currentCandles.map(c => c.close);
    const times  = currentCandles.map(c => c.time);

    const ema12 = ema(closes, 12);
    const ema26 = ema(closes, 26);

    const sma20 = rollingMean(closes, 20);
    const std20 = rollingStd(closes, 20);
    const bbUpper = std20.map((s,i)=> s==null||sma20[i]==null? null : sma20[i] + 2*s);
    const bbLower = std20.map((s,i)=> s==null||sma20[i]==null? null : sma20[i] - 2*s);

    const ret = closes.map((v,i)=> i===0 ? 0 : Math.log(v / closes[i-1]));

    const rMean = rollingMean(ret, 20);
    const rStd  = rollingStd(ret, 20).map(s => (s==null || s === 0) ? 1e-12 : s);
    const zscore = ret.map((r,i)=> rMean[i]==null? null : (r - rMean[i]) / rStd[i]);

    const rv = rollingStd(ret, 20);
    const secondsPerYear = 365 * 24 * 3600;
    const periodsPerYear = secondsPerYear / Math.max(1, currentIntervalSec);
    const rvAnn = rv.map(v => v == null ? null : v * Math.sqrt(periodsPerYear));

    const mk = (vals) => times.map((t,i)=> vals[i]==null ? null : ({ time:t, value:vals[i] })).filter(Boolean);
    const makeLine = (obj, key, opts) => { if (!obj[key]) obj[key] = chart.addLineSeries(Object.assign({ priceLineVisible:false }, opts)); return obj[key]; }

    makeLine(overlaySeries, 'ema12',  { color:'#3b82f6', lineWidth:2 }).setData(mk(ema12));
    makeLine(overlaySeries, 'ema26',  { color:'#f97316', lineWidth:2 }).setData(mk(ema26));
    makeLine(overlaySeries, 'bbUpper',{ color:'#6b7280', lineWidth:1 }).setData(mk(bbUpper));
    makeLine(overlaySeries, 'bbLower',{ color:'#6b7280', lineWidth:1 }).setData(mk(bbLower));

    plotCanvasLineAligned('zscoreCanvas', times, zscore, { color:'#fff', center:0, valueElId:'zscoreVal', format:(v)=>formatNumber(v,3) });
    plotCanvasLineAligned('volCanvas',    times, rvAnn,  { color:'#fff', valueElId:'volVal', format:(v)=>formatVol(v) });
  }

  function formatNumber(v, dp) {
    if (v == null || !isFinite(v)) return '--';
    return Number(v).toFixed(dp);
  }
  function formatVol(v){
    if (v == null || !isFinite(v)) return '--';
    const a = Math.abs(v);
    if (a >= 1) return v.toFixed(3);
    if (a >= 0.01) return v.toFixed(4);
    if (a >= 0.0001) return v.toFixed(6);
    return v.toExponential(2);
  }

  function percentile(arr, p) {
    if (!arr || arr.length === 0) return null;
    const a = arr.slice().sort((x,y)=>x-y);
    const n = a.length;
    const idx = (n - 1) * p;
    const lo = Math.floor(idx);
    const hi = Math.ceil(idx);
    if (hi === lo) return a[lo];
    const frac = idx - lo;
    return a[lo] * (1 - frac) + a[hi] * frac;
  }

  function plotCanvasLineAligned(canvasId, times, values, opts) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const defined = values.map((v,i)=> v==null? null : { i, v }).filter(Boolean);

    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const DPR = Math.max(1, window.devicePixelRatio || 1);
    canvas.width  = Math.floor(rect.width * DPR);
    canvas.height = Math.floor(rect.height * DPR);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(DPR, DPR);
    ctx.clearRect(0,0,rect.width,rect.height);

    if (!defined.length) {
      const el = document.getElementById(opts.valueElId||'');
      if (el) el.textContent='--';
      drawTimeLabels(canvas, times);
      return;
    }

    const numericValues = defined.map(d => d.v);
    const lowP = percentile(numericValues, 0.05);
    const highP = percentile(numericValues, 0.95);

    let plotMin = (lowP == null ? Math.min(...numericValues) : lowP);
    let plotMax = (highP == null ? Math.max(...numericValues) : highP);
    if (!isFinite(plotMin) || !isFinite(plotMax) || plotMax === plotMin) {
      plotMin = Math.min(...numericValues);
      plotMax = Math.max(...numericValues);
    }
    const range = (plotMax - plotMin) || Math.abs(plotMax) || 1;

    const padding = 12;
    const w = rect.width - padding*2;
    const h = rect.height - padding*2;

    ctx.strokeStyle = opts.color || '#ffffff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    defined.forEach((d, k) => {
      let v = d.v;
      if (v < plotMin) v = plotMin;
      if (v > plotMax) v = plotMax;
      const x = padding + (d.i / (values.length - 1)) * w;
      const y = padding + h - ((v - plotMin) / range) * h;
      if (k === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();

    if (opts.center !== undefined) {
      const cy = padding + h - ((opts.center - plotMin) / range) * h;
      ctx.setLineDash([5,5]);
      ctx.strokeStyle = '#666';
      ctx.beginPath(); ctx.moveTo(padding, cy); ctx.lineTo(padding + w, cy); ctx.stroke();
      ctx.setLineDash([]);
    }

    const last = defined[defined.length - 1].v;
    const valEl = document.getElementById(opts.valueElId || '');
    if (valEl) valEl.textContent = (opts.format ? opts.format(last) : String(last));

    drawTimeLabels(canvas, times);
  }

  function drawTimeLabels(canvas, times){
    if (!canvas || !Array.isArray(times) || times.length===0) return;
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const DPR = Math.max(1, window.devicePixelRatio || 1);

    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(DPR, DPR);

    const labelHeight = 18;
    ctx.clearRect(0, rect.height - labelHeight - 2, rect.width, labelHeight + 2);

    ctx.fillStyle = '#cbd5e1';
    ctx.font = '12px "Courier New", monospace';
    ctx.textBaseline = 'top';

    const leftT = new Date(times[0]*1000).toLocaleString();
    const midT  = new Date(times[Math.floor(times.length/2)]*1000).toLocaleString();
    const rightT= new Date(times[times.length-1]*1000).toLocaleString();

    ctx.fillText(leftT, 6, rect.height - labelHeight + 0);
    const midWidth = ctx.measureText(midT).width;
    ctx.fillText(midT, Math.max((rect.width - midWidth)/2, 6), rect.height - labelHeight + 0);
    const rightWidth = ctx.measureText(rightT).width;
    ctx.fillText(rightT, Math.max(rect.width - rightWidth - 6, 6), rect.height - labelHeight + 0);
  }

  // update live tick
  function updateLive(price, isoTs) {
    if (!candleSeries) return;
    const tsSec = Math.floor(new Date(isoTs.replace(' ', 'T')).getTime()/1000);
    const bucket = Math.floor(tsSec / resolutionSec) * resolutionSec;
    const p = Number(price);
    let c = candleBuckets.get(bucket);
    if (!c) {
      c = { time: bucket, open: p, high: p, low: p, close: p };
      candleBuckets.set(bucket, c);
      currentCandles.push(c);
      candleSeries.update(c);
    } else {
      c.high = Math.max(c.high, p);
      c.low = Math.min(c.low, p);
      c.close = p;
      candleSeries.update(c);
      const idx = currentCandles.findIndex(cc => cc.time === c.time);
      if (idx >= 0) currentCandles[idx] = c;
    }

    try { computeAndRenderIndicatorsFromCandles(); } catch (err) { console.warn('indicator recompute error', err); }
  }

  // addRow for the price table — colored price cell based on delta
  function addRow(d) {
    if (!d || d.price == null) return;
    const tbody = document.getElementById('tbody');
    const tr = document.createElement('tr');

    const direction = (d.delta || 0) > 0 ? 'up' : ((d.delta || 0) < 0 ? 'down' : 'flat');
    const priceClass = direction === 'up' ? 'price-up' : (direction === 'down' ? 'price-down' : '');

    const ts = new Date((d.timestamp || '').replace(' ', 'T')).toLocaleTimeString([], { hour12: false });
    const price = Number(d.price).toFixed(2);
    const move = d.delta == null ? '' : `${d.delta >= 0 ? '+' : ''}${Number(d.delta).toFixed(2)}`;
    const pct = d.percent_change == null ? '' : `${d.percent_change >= 0 ? '+' : ''}${Number(d.percent_change).toFixed(2)}%`;

    tr.className = 'newest';
    tr.innerHTML = `<td class="mono">${ts}</td>
                    <td class="mono ${priceClass}">$${price}</td>
                    <td class="mono ${direction}">${move}</td>
                    <td class="mono ${direction}">${pct}</td>`;

    if (tbody.firstChild) { tbody.firstChild.classList.remove('newest'); tbody.insertBefore(tr, tbody.firstChild); }
    else { tbody.appendChild(tr); }

    while (tbody.children.length > 300) tbody.removeChild(tbody.lastChild);
  }

  async function pollPriceOnce() {
    try {
      const res = await fetch('http://localhost:8000/api/price');
      const d = await res.json();
      document.getElementById('status').textContent = 'Connected - Live';
      document.getElementById('status').style.color = 'green';
      addRow(d);
      updateLive(d.price, d.timestamp);
    } catch(e) {
      document.getElementById('status').textContent = 'Disconnected - retrying...';
      document.getElementById('status').style.color = 'red';
    }
  }

  async function loadHistory(range='1h') {
    try {
      const params = { '1h':{m:60,res:'1',sec:60}, '1d':{m:24*60,res:'5',sec:300}, '1w':{m:7*24*60,res:'30',sec:1800}, '1m':{m:30*24*60,res:'60',sec:3600} }[range] || {m:60,res:'1',sec:60};
      const url = `http://localhost:8000/api/history?minutes=${params.m}&resolution=${encodeURIComponent(params.res)}`;
      const res = await fetch(url);
      const data = await res.json();
      setHistory(data, params.sec);
    } catch(e) { console.warn('history load failed', e); }
  }

  // timeframe buttons
  document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('click', async (ev) => {
      document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
      ev.target.classList.add('active');
      await loadHistory(ev.target.dataset.range || '1h');
    });
  });

  // init
  ensureChart();
  document.querySelector('.btn[data-range="1h"]').classList.add('active');
  loadCryptos();
  loadHistory('1h');
  setInterval(pollPriceOnce, 1000);
  setInterval(() => computeAndRenderIndicatorsFromCandles(), 2000);
})();
</script>

<!-- Strategy UI behavior (delegated; keeps working even if DOM changes) -->
<script>
(function(){
  if (!document.getElementById('qtySuggestions')) {
    const dl = document.createElement('datalist');
    dl.id = 'qtySuggestions';
    dl.innerHTML = '<option value="1"></option><option value="5"></option><option value="10"></option>';
    document.body.appendChild(dl);
  }

  function selectHTML(pre){
    return `
      <select class="str-select">
        <option value="" ${pre ? '' : 'selected'} disabled>Select…</option>
        <option value="a" ${pre==='a'?'selected':''}>a</option>
        <option value="b" ${pre==='b'?'selected':''}>b</option>
        <option value="c" ${pre==='c'?'selected':''}>c</option>
      </select>
    `;
  }
  function splitHTML(val, type){
    return `
      <div class="str-split">
        <button type="button" class="str-pill" data-value="${val}" aria-label="${type} selection">${val}</button>
        <input class="str-number" type="number" placeholder="Enter number" min="0" step="1" list="qtySuggestions" />
      </div>
    `;
  }

  document.addEventListener('click', function(e){
    const addBtn = e.target.closest('#strategyScreen .str-add, #strategy-content .str-add');
    if (!addBtn) return;
    const card   = addBtn.closest('.str-card');
    const rowsEl = card.querySelector('.str-rows');
    const type   = card.dataset.card;
    const row    = document.createElement('div');
    row.className = 'str-row';
    row.dataset.type = type;
    row.innerHTML = selectHTML();
    rowsEl.appendChild(row);
  });

  document.addEventListener('change', function(e){
    const sel = e.target.closest('#strategyScreen .str-select, #strategy-content .str-select');
    if (!sel) return;
    const row  = sel.closest('.str-row');
    const type = row?.dataset?.type;
    const val  = sel.value;
    if (!val) return;
    if (type === 'buy' || type === 'sell') {
      row.innerHTML = splitHTML(val, type);
    }
  });

  document.addEventListener('click', function(e){
    const pill = e.target.closest('#strategyScreen .str-pill, #strategy-content .str-pill');
    if (!pill) return;
    const row     = pill.closest('.str-row');
    const type    = row?.dataset?.type || 'buy';
    const current = pill.dataset.value || 'a';
    row.innerHTML = selectHTML(current);
  });
})();
</script>

</body>
</html>
